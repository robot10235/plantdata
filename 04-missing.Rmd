# Missing values

```{r}
library(ggplot2)
library(tidyverse)
library(patchwork)
```

define a function which can be used to analyze our data
```{r}
visna <- function(df,type='counts') {
  num_rows <- nrow(df)
  num_cols <- ncol(df)

  missing_patterns <- data.frame(is.na(df)) %>%
    group_by_all() %>%
    count(name = "count", sort = TRUE) %>%
    ungroup()

  if(type == 'percents') {
    missing_patterns <- missing_patterns %>%
      mutate(count = count / num_rows * 100)
  }

  # Modify missing patterns to generate main graph
  missing_patterns_main <- missing_patterns %>%
    mutate(id = row_number(),.before=1) %>%
    pivot_longer(cols = -c("id", "count"), 
                 names_to = "variables", 
                 values_to = "value") %>%
    group_by(variables) %>%
    mutate(var_count = sum(count[value == TRUE])) %>%
    ungroup() %>%
    group_by(id) %>%
    mutate(complete = as.character(ifelse(sum(value) == 0, 1, 0))) %>%
    ungroup()

  # Set colors for main graph (not using defaults)
  tile_colors <- c("grey", "mediumpurple1")

  # Plot main graph
  main_plot <- ggplot(missing_patterns_main, aes(x = reorder(variables, -var_count), 
                                                 y = fct_rev(factor(id)), 
                                                 fill = value, 
                                                 alpha = complete)) + 
               geom_tile(color = "white", show.legend = FALSE) + 
               scale_fill_manual(values = tile_colors) + 
               scale_alpha_manual(values = c("1" = 0.5, "0" = 1)) + 
               labs(x = "variables", y = "missing pattern") + 
               theme_bw() +
               theme(legend.position = "none")

  complete_case <- unique(missing_patterns_main$id[which(missing_patterns_main$complete==1)])
  x <- as.integer(num_cols/2)+1
  for (i in complete_case) {
    y <- nrow(missing_patterns) - as.integer(i) + 1
    main_plot <- main_plot + geom_text(aes(x, y, label='complete case'), size=4, family="Times New Roman")
  }

  # Modify missing patterns to generate top graph
  missing_patterns_top <- missing_patterns_main %>%
    group_by(variables) %>%
    summarise(missing_rows = sum(count[value == TRUE])) %>%
    ungroup()

  # Plot top graph
  top_plot <- ggplot(missing_patterns_top) + 
          geom_col(aes(x = reorder(variables, -missing_rows),
                       y = missing_rows), 
                   fill = "cornflowerblue") + 
          labs(title = "Missing value patterns", x = "") + 
          theme_bw() + 
          theme(panel.grid.major.x = element_blank(), 
                panel.grid.minor.x = element_blank(),
                legend.position = "none")
  
  if(type == "percents") {
    top_plot <- top_plot +
      scale_y_continuous(limits=c(0,100),breaks=seq(0,100,by=25)) +
      labs(y = "% rows missing: ")
  }
  else {
    top_plot <- top_plot + 
      scale_y_continuous(breaks = c(0, 20, 10)) +
      labs(y = "num rows missing: ")
  }


  # Modify missing patterns to generate right graph
  missing_patterns_right <- missing_patterns_main %>%
    select(id, count, complete)
  missing_patterns_right <- unique(missing_patterns_right)

  # Plot right graph
  right_plot <- ggplot(missing_patterns_right,aes(x=count,y=factor(id),fill=complete))+
    geom_col()+
    scale_fill_manual(values=c('cornflowerblue','blue'))+
    scale_y_discrete(limits=rev)+
    ylab("") +
    theme(panel.grid.major.y = element_blank(), 
                panel.grid.minor.y = element_blank(),
                legend.position = "none")

  if(type == 'percents') {
    right_plot <- right_plot + 
      scale_x_continuous(limits=c(0,100), breaks=seq(0,100,by=25)) +
      xlab("% rows")
  }

  else {
    right_plot <- right_plot + 
      xlab("num rows")  
  }

  # Set layout for plots assembly
  layout <- c(area(1, 1, 1, 4), area(2, 1, 5, 4), area(2, 5, 5, 5))

  # Assemble graphs
  top_plot + main_plot + right_plot + plot_layout(design = layout)
}
```

import data and purge it simply
```{r}
data <- read.csv("usplant.csv", quote = "", sep = "\t", encoding = "UTF-8")
df <- data[c(10,18,22,23,26,27,28,29,31,32,33)]
colnames(df) <- c('SP','ST','LA','LO','ELE','EA','DP','DPA','D','M','Y')
```

visualize the missing pattern
```{r}
visna(df)
```
Observing the plot, we can easily find out some correlations among some factors. LA means latitude and LO means longitude, so if one of them is missing, the other one must be missing too. The plot reveals this correlation. In addition, DPA means deep accuracy and DP means depth, if depth exists, depth accuracy has much probability to exist. The similar correlation also appears between EA(elevation accuracy) and ELE(elevation). Another correlation is among Y(year), M(month) and D(day). Year is more easily be recorded, rather than month and day.

DA, DP, EA, ELE are more likely to be missing, because few plants need to be recorded these information. For example, we may need to record deep of marine plants. But we wouldn't record deep of terrestrial plants. And it is easier to record terrestrial plants and the amount of terrestrial plants is bigger. It is similar for elevation, since researchers may record the elevation when the plants are living in the mountains.

SP, ST, Y has no missing at all. That's because SP(species) is somehow a index for the data. ST(state) and Y(year) is much easier to record. 



